# V. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑ§Í≥Ñ ÏÉÅÏÑ∏ Î™ÖÏÑ∏ (ÏµúÏ¢Ö ÌÜµÌï© Î≤ÑÏ†Ñ)

**ÏµúÏ¢Ö ÏóÖÎç∞Ïù¥Ìä∏**: 2024ÎÖÑ 12Ïõî 27Ïùº  
**Í∏∞Î∞ò**: Ïã§Ï†ú Ïä§ÌÇ§Îßà ÌååÏùº (shared/schema.ts 15KB, 300Ï§Ñ)

---

## üóÑÔ∏è Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Í∞úÏöî

### Í∏∞Ïà† Ïä§ÌÉù
- **DBMS**: PostgreSQL 15+ (Supabase)
- **ORM**: Drizzle ORM 0.39.1
- **Ïä§ÌÇ§Îßà Í¥ÄÎ¶¨**: ÌÉÄÏûÖ ÏïàÏ†Ñ Ïä§ÌÇ§Îßà Ï†ïÏùò
- **ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò**: supabase/migrations/

---

## üìä Ï†ÑÏ≤¥ ERD Íµ¨Ï°∞

```mermaid
erDiagram
    users ||--o{ flashTrades : creates
    users ||--o{ walletTransactions : owns
    users ||--o{ kycDocuments : submits
    users ||--o{ quantAiInvestments : invests
    users ||--o{ quickTradePositions : trades
    users ||--o{ userFlashTradeRules : hasRules
    users ||--o{ notifications : receives
    
    adminUsers ||--o{ adminPermissions : hasPermissions
    adminUsers ||--o{ walletTransactions : approves
    adminUsers ||--o{ kycDocuments : reviews
    
    vipLevelSettings ||--o{ users : applies
```

---

## üèóÔ∏è ÌïµÏã¨ ÌÖåÏù¥Î∏î Íµ¨Ï°∞

### 1. users (ÏÇ¨Ïö©Ïûê ÌÖåÏù¥Î∏î)
```sql
CREATE TABLE users (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email                   VARCHAR(255) UNIQUE NOT NULL,
    firstName               VARCHAR(100) NOT NULL,
    lastName                VARCHAR(100) NOT NULL,
    nickname                VARCHAR(100),
    password                VARCHAR(255) NOT NULL,
    role                    VARCHAR(20) DEFAULT 'user' NOT NULL,
    balance                 DECIMAL(15,2) DEFAULT '10000.00',
    vipLevel                INTEGER DEFAULT 1,
    assignedAdminId         UUID,
    withdrawalPasswordHash  VARCHAR(255),
    lastLoginIp             VARCHAR(45),
    lastLoginAt             TIMESTAMP WITH TIME ZONE,
    restrictedTradeTypes    JSONB,
    isActive                BOOLEAN DEFAULT true,
    createdAt               TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updatedAt               TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2. flashTrades (Flash Trade Í±∞Îûò)
```sql
CREATE TABLE flashTrades (
    id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    userId        UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
    amount        DECIMAL(15,2) NOT NULL,
    direction     VARCHAR(10) NOT NULL, -- 'up', 'down'
    duration      INTEGER NOT NULL,     -- Ï¥à Îã®ÏúÑ
    startPrice    DECIMAL(15,8) NOT NULL,
    endPrice      DECIMAL(15,8),
    result        VARCHAR(10),          -- 'win', 'lose'
    profit        DECIMAL(15,2),
    status        VARCHAR(20) DEFAULT 'active', -- 'active', 'completed', 'cancelled'
    adminOverride BOOLEAN DEFAULT false,
    createdAt     TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    expiresAt     TIMESTAMP WITH TIME ZONE NOT NULL
);
```

### 3. adminUsers (Í¥ÄÎ¶¨Ïûê ÏÇ¨Ïö©Ïûê)
```sql
CREATE TABLE adminUsers (
    id             UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email          VARCHAR(255) UNIQUE NOT NULL,
    hashedPassword VARCHAR(255) NOT NULL,
    name           VARCHAR(100) NOT NULL,
    role           VARCHAR(20) DEFAULT 'admin' NOT NULL, -- 'superadmin', 'admin'
    isActive       BOOLEAN DEFAULT true,
    createdAt      TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updatedAt      TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 4. userFlashTradeRules (Í±∞Îûò Í∑úÏπô)
```sql
CREATE TABLE userFlashTradeRules (
    id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    userId            UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
    mode              VARCHAR(20) NOT NULL, -- 'force_win', 'force_lose', 'random'
    winRate           DECIMAL(5,2),         -- ÎûúÎç§ Î™®ÎìúÏùº Îïå ÏäπÎ•†
    validFrom         TIMESTAMP WITH TIME ZONE,
    validUntil        TIMESTAMP WITH TIME ZONE,
    minAmountFilter   DECIMAL(15,2),
    maxAmountFilter   DECIMAL(15,2),
    isActive          BOOLEAN DEFAULT true,
    createdAt         TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updatedAt         TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## üí∞ ÏßÄÍ∞ë Î∞è Í±∞Îûò ÌÖåÏù¥Î∏î

### walletTransactions (ÏßÄÍ∞ë Í±∞Îûò)
```sql
CREATE TABLE walletTransactions (
    id                   UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    userId               UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
    type                 VARCHAR(20) NOT NULL, -- 'deposit', 'withdrawal', 'bonus', 'trade'
    coin                 VARCHAR(10) NOT NULL,
    network              VARCHAR(20),
    amount               DECIMAL(20,8) NOT NULL,
    address              VARCHAR(255),
    txHash               VARCHAR(255),
    screenshotUrl        VARCHAR(500),
    bonusAppliedAmount   DECIMAL(15,2),
    adminApproverId      UUID REFERENCES adminUsers(id),
    rejectionReason      TEXT,
    status               VARCHAR(20) DEFAULT 'pending', -- 'pending', 'approved', 'rejected'
    createdAt            TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    processedAt          TIMESTAMP WITH TIME ZONE
);
```

### kycDocuments (KYC Î¨∏ÏÑú)
```sql
CREATE TABLE kycDocuments (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    userId              UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
    documentType        VARCHAR(50) NOT NULL, -- 'id_front', 'id_back', 'selfie', 'address_proof'
    documentUrl         VARCHAR(500) NOT NULL,
    verificationLevel   INTEGER NOT NULL,     -- 1, 2
    status              VARCHAR(20) DEFAULT 'pending', -- 'pending', 'approved', 'rejected'
    adminReviewerId     UUID REFERENCES adminUsers(id),
    rejectionReason     TEXT,
    createdAt           TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    reviewedAt          TIMESTAMP WITH TIME ZONE
);
```

---

## ü§ñ AI Ìà¨Ïûê Î∞è Quick Trade

### quantAiInvestments (ÌÄÄÌä∏ AI Ìà¨Ïûê)
```sql
CREATE TABLE quantAiInvestments (
    id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    userId            UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
    strategyName      VARCHAR(100) NOT NULL,
    investmentAmount  DECIMAL(15,2) NOT NULL,
    investmentPeriod  INTEGER NOT NULL,        -- Ïùº Îã®ÏúÑ
    dailyReturnRate   DECIMAL(5,4) NOT NULL,
    currentValue      DECIMAL(15,2) NOT NULL,
    totalReturn       DECIMAL(15,2) DEFAULT '0',
    status            VARCHAR(20) DEFAULT 'active', -- 'active', 'completed', 'cancelled'
    autoReinvest      BOOLEAN DEFAULT false,
    createdAt         TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completedAt       TIMESTAMP WITH TIME ZONE,
    updatedAt         TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### quickTradePositions (ÌÄµ Ìä∏Î†àÏù¥Îìú)
```sql
CREATE TABLE quickTradePositions (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    userId      UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
    symbol      VARCHAR(20) NOT NULL,
    side        VARCHAR(10) NOT NULL,     -- 'buy', 'sell'
    amount      DECIMAL(15,2) NOT NULL,
    leverage    INTEGER DEFAULT 1,
    entryPrice  DECIMAL(15,8) NOT NULL,
    exitPrice   DECIMAL(15,8),
    status      VARCHAR(20) DEFAULT 'open', -- 'open', 'closed'
    pnl         DECIMAL(15,2) DEFAULT '0',
    createdAt   TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    closedAt    TIMESTAMP WITH TIME ZONE
);
```

---

## ‚öôÔ∏è ÏãúÏä§ÌÖú Í¥ÄÎ¶¨ ÌÖåÏù¥Î∏î

### adminSettings (Í¥ÄÎ¶¨Ïûê ÏÑ§Ï†ï)
```sql
CREATE TABLE adminSettings (
    id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    settingKey   VARCHAR(100) UNIQUE NOT NULL,
    settingValue JSONB NOT NULL,
    description  TEXT,
    createdAt    TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updatedAt    TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### vipLevelSettings (VIP Î†àÎ≤®)
```sql
CREATE TABLE vipLevelSettings (
    level                        INTEGER PRIMARY KEY,
    name                         VARCHAR(50) NOT NULL,
    minCumulativeTradeVolume     DECIMAL(20,2),
    tradeFeeDiscountPercent      DECIMAL(5,2) DEFAULT '0',
    withdrawalPriority           INTEGER DEFAULT 0,
    customBenefitsDescription    TEXT,
    createdAt                    TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updatedAt                    TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## üîí Î≥¥Ïïà Î∞è Ï†ëÍ∑º Ï†úÏñ¥

### adminPermissions (Í¥ÄÎ¶¨Ïûê Í∂åÌïú)
```sql
CREATE TABLE adminPermissions (
    id         UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    adminId    UUID REFERENCES adminUsers(id) ON DELETE CASCADE NOT NULL,
    featureKey VARCHAR(100) NOT NULL,
    canView    BOOLEAN DEFAULT false,
    canEdit    BOOLEAN DEFAULT false,
    canCreate  BOOLEAN DEFAULT false,
    canDelete  BOOLEAN DEFAULT false,
    canApprove BOOLEAN DEFAULT false,
    createdAt  TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### ipRestrictions (IP Ï†úÌïú)
```sql
CREATE TABLE ipRestrictions (
    id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    type         VARCHAR(10) NOT NULL, -- 'ALLOW', 'DENY'
    countryCode  VARCHAR(2),
    ipRangeStart INET,
    ipRangeEnd   INET,
    userId       UUID REFERENCES users(id) ON DELETE CASCADE,
    description  TEXT,
    isActive     BOOLEAN DEFAULT true,
    createdAt    TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## üìà Ïù∏Îç±Ïä§ Î∞è ÏµúÏ†ÅÌôî

### Ï£ºÏöî Ïù∏Îç±Ïä§
```sql
-- ÏÑ±Îä• ÏµúÏ†ÅÌôîÎ•º ÏúÑÌïú Ïù∏Îç±Ïä§
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_flashTrades_userId ON flashTrades(userId);
CREATE INDEX idx_flashTrades_status ON flashTrades(status);
CREATE INDEX idx_flashTrades_expiresAt ON flashTrades(expiresAt);
CREATE INDEX idx_walletTransactions_userId ON walletTransactions(userId);
CREATE INDEX idx_walletTransactions_status ON walletTransactions(status);
```

### Ï†úÏïΩ Ï°∞Í±¥
```sql
-- ÎπÑÏ¶àÎãàÏä§ Î°úÏßÅ Ï†úÏïΩ
ALTER TABLE flashTrades ADD CONSTRAINT chk_direction 
    CHECK (direction IN ('up', 'down'));
ALTER TABLE flashTrades ADD CONSTRAINT chk_result 
    CHECK (result IN ('win', 'lose'));
ALTER TABLE users ADD CONSTRAINT chk_role 
    CHECK (role IN ('user', 'admin', 'superadmin'));
```

---

## ‚úÖ Íµ¨ÌòÑ ÏôÑÎ£å ÏÉÅÌÉú

### 100% ÏôÑÎ£åÎêú ÌÖåÏù¥Î∏î (22Í∞ú)
- [x] users (ÏÇ¨Ïö©Ïûê Í∏∞Î≥∏ Ï†ïÎ≥¥)
- [x] flashTrades (Flash Trade Í±∞Îûò)
- [x] userFlashTradeRules (Í±∞Îûò Í∑úÏπô)
- [x] adminUsers (Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ï)
- [x] adminPermissions (Í∂åÌïú Í¥ÄÎ¶¨)
- [x] walletTransactions (ÏßÄÍ∞ë Í±∞Îûò)
- [x] kycDocuments (KYC Î¨∏ÏÑú)
- [x] quantAiInvestments (AI Ìà¨Ïûê)
- [x] quickTradePositions (ÌÄµ Ìä∏Î†àÏù¥Îìú)
- [x] adminSettings (ÏãúÏä§ÌÖú ÏÑ§Ï†ï)
- [x] vipLevelSettings (VIP Îì±Í∏â)
- [x] ipRestrictions (IP Ï†úÌïú)
- [x] userIpLogs (IP Î°úÍ∑∏)
- [x] notifications (ÏïåÎ¶º)

### Îç∞Ïù¥ÌÑ∞ Î¨¥Í≤∞ÏÑ±
- **Ï∞∏Ï°∞ Î¨¥Í≤∞ÏÑ±**: Î™®Îì† Ïô∏ÎûòÌÇ§ Ï†úÏïΩÏ°∞Í±¥ ÏÑ§Ï†ï
- **ÎèÑÎ©îÏù∏ Î¨¥Í≤∞ÏÑ±**: CHECK Ï†úÏïΩÏ°∞Í±¥ÏúºÎ°ú Í∞í Î≤îÏúÑ Ï†úÌïú
- **ÏóîÌã∞Ìã∞ Î¨¥Í≤∞ÏÑ±**: Î™®Îì† ÌÖåÏù¥Î∏îÏóê Í∏∞Î≥∏ÌÇ§ ÏÑ§Ï†ï

---

**Îã§Ïùå Î¨∏ÏÑú**: VI. Ïù∏ÌîÑÎùº Î∞è Î∞∞Ìè¨ Î™ÖÏÑ∏ 